{"componentChunkName":"component---src-templates-blog-post-js","path":"/piholeで広告ブロック/","result":{"data":{"site":{"siteMetadata":{"title":"eginoy Blog"}},"markdownRemark":{"id":"642e773d-6ab3-5e40-86b5-b1a06b009589","excerpt":"アプリ内ブラウザでの広告が目障り PCではブラウザ拡張のAdBlockなどを使用しているので広告除去ができている。 しかし、スマートフォンのアプリ内ブラウザでは上記の方法で広告除去ができない。 Pi-holeというOSSでDNSサーバーを自前で立てて、スマートフォン側でDNSサーバーにPi-hole…","html":"<h3>アプリ内ブラウザでの広告が目障り</h3>\n<p>PCではブラウザ拡張のAdBlockなどを使用しているので広告除去ができている。<br>\nしかし、スマートフォンのアプリ内ブラウザでは上記の方法で広告除去ができない。<br>\n<a href=\"https://github.com/pi-hole/docker-pi-hole\">Pi-holeというOSS</a>でDNSサーバーを自前で立てて、スマートフォン側でDNSサーバーにPi-holeを指定することで、広告除去ができるようなので設定を行った。<br>\nすでに録画サーバーをRaspiberry pi4で運用しているので、こちらにPi-holeをインストールすることにした。<br>\n運用中の環境を汚したくないため、公式のdocker-composeファイルを利用してDNSサーバーを立てる。</p>\n<h3>環境</h3>\n<p>DNSサーバー</p>\n<ul>\n<li>Raspberry Pi4 4GB</li>\n<li>Ubuntu 20.04.1 LTS</li>\n<li>Docker version 19.03.8</li>\n<li>docker-compose version 1.27.4</li>\n</ul>\n<h3>Pi-holeのセットアップ</h3>\n<p>基本的には<a href=\"https://github.com/pi-hole/docker-pi-hole\">公式のドキュメント</a>からdocker-composeファイルをコピペして動かすだけ。  </p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"3\"</span>\n\n<span class=\"token comment\"># More info at https://github.com/pi-hole/docker-pi-hole/ and https://docs.pi-hole.net/</span>\n<span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">pihole</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">container_name</span><span class=\"token punctuation\">:</span> pihole\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> pihole/pihole<span class=\"token punctuation\">:</span>latest\n    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"53:53/tcp\"</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"53:53/udp\"</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"67:67/udp\"</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"80:80/tcp\"</span>\n    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">TZ</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'America/Chicago'</span>\n      <span class=\"token comment\"># WEBPASSWORD: 'set a secure password here or it will be random'</span>\n    <span class=\"token comment\"># Volumes store your data between container upgrades</span>\n    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">'./etc-pihole/:/etc/pihole/'</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">'./etc-DNSmasq.d/:/etc/DNSmasq.d/'</span>\n    <span class=\"token comment\"># Recommended but not required (DHCP needs NET_ADMIN)</span>\n    <span class=\"token comment\">#   https://github.com/pi-hole/docker-pi-hole#note-on-capabilities</span>\n    <span class=\"token key atrule\">cap_add</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> NET_ADMIN\n    <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> unless<span class=\"token punctuation\">-</span>stopped</code></pre></div>\n<p>しかし、Ubuntu 17.10以降で利用する場合、システムにデフォルトで有効になっているDNS resolverがPi-holeで使用する53ポートを既に使用しているため、コンテナを立ち上げる際にエラーが発生する。<br>\n以下のコマンドでPi-holeが53ポートを使用できるようにする。<br>\n<code class=\"language-text\">sudo sed -r -i.orig &#39;s/#?DNSStubListener=yes/DNSStubListener=no/g&#39; /etc/systemd/resolved.conf</code><br>\n<code class=\"language-text\">sudo sh -c &#39;rm /etc/resolv.conf &amp;&amp; ln -s /run/systemd/resolve/resolv.conf /etc/resolv.conf</code><br>\n<code class=\"language-text\">systemctl restart systemd-resolved</code>  </p>\n<p>コンテナの起動<br>\n<code class=\"language-text\">docker-compose up -d</code></p>\n<p>クライアントからDNSサーバーを指定する際に、ipアドレスが必要なので確認しておく。<br>\n<code class=\"language-text\">hostname -I</code>  </p>\n<h3>クライアントの設定</h3>\n<p>スマートフォン(iPhone SE2)の設定は以下の手順で行った。<br>\nDNSサーバーのアドレスは<code class=\"language-text\">192.168.0.10</code>とする。</p>\n<ol>\n<li>設定</li>\n<li>Wi-Fi</li>\n<li>接続しているアクセスポイントのiマークをタップ</li>\n<li>画面下部のDNSを構成</li>\n<li>手動にチェックを入れる</li>\n<li>すでに設定されているDNSサーバーをすべて削除</li>\n<li><code class=\"language-text\">192.168.0.10</code>を入力して保存</li>\n</ol>\n<p>設定前<br>\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/6cf486f6a81c52bd627dce555f78a729/acb04/before.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 177.8481012658228%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAkABQDASIAAhEBAxEB/8QAGgABAAIDAQAAAAAAAAAAAAAAAAIDAQQFBv/EABcBAAMBAAAAAAAAAAAAAAAAAAABAgP/2gAMAwEAAhADEAAAAZy6GLnluwCqvYxncUjPNgVAc//EAB0QAAICAwADAAAAAAAAAAAAAAACAQMREhMEFCL/2gAIAQEAAQUCXxq2PUU4VGxsQ2Rpga3C12bxsrGVOlSi32Ks2vlvuf/EABURAQEAAAAAAAAAAAAAAAAAABAR/9oACAEDAQE/AWv/xAAXEQADAQAAAAAAAAAAAAAAAAAAESAh/9oACAECAQE/AUZP/8QAHxAAAgICAQUAAAAAAAAAAAAAAAECESEyMxIxQYGR/9oACAEBAAY/AsTb9GzOWXw0ONmjHZaLRayeDMoo6VLB3Llln//EACAQAQACAgEEAwAAAAAAAAAAAAEAESExURBBgaGR0fH/2gAIAQEAAT8hsPPwjn0nRzV29S/4fcqZD4ljFuY6Kus1LHSNahpJ5AZ22ngmovwoQesJQVFWbY4jewFT/9oADAMBAAIAAwAAABAM4LGL3//EABoRAAICAwAAAAAAAAAAAAAAAAABEBEhMVH/2gAIAQMBAT8QsyMpw20nH//EABsRAAICAwEAAAAAAAAAAAAAAAABEaEQQVHR/9oACAECAQE/EGulZHNrzCIRB//EAB8QAQACAQQDAQAAAAAAAAAAAAEAESExQVGRYXGh8f/aAAgBAQABPxCgAFWhjshYgrBJNpJMVs+S9C8dP1M28a4g9uU4y+yzIohvi4oMoJoo5ZhwtC0ut/UuRvZId7xBp5hhQNaMk81ME5RNHUNGabscQ2+BbTB6n//Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"設定前\"\n        title=\"設定前\"\n        src=\"/static/6cf486f6a81c52bd627dce555f78a729/828fb/before.jpg\"\n        srcset=\"/static/6cf486f6a81c52bd627dce555f78a729/ff44c/before.jpg 158w,\n/static/6cf486f6a81c52bd627dce555f78a729/a6688/before.jpg 315w,\n/static/6cf486f6a81c52bd627dce555f78a729/828fb/before.jpg 630w,\n/static/6cf486f6a81c52bd627dce555f78a729/acb04/before.jpg 750w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>  </p>\n<p>設定後\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ce47549d903a404be0e80537e8f5eb06/acb04/after.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 177.8481012658228%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAkABQDASIAAhEBAxEB/8QAGQABAAMBAQAAAAAAAAAAAAAAAAECBQMG/8QAFwEBAQEBAAAAAAAAAAAAAAAAAQACA//aAAwDAQACEAMQAAABvbQjectsKtekc99EE8vIgR//xAAdEAABBAMBAQAAAAAAAAAAAAAAAQIDEhARFAQT/9oACAEBAAEFAm+aNxyNPhEWLCO2URSqY3jZ0SnRKdMx/8QAFhEAAwAAAAAAAAAAAAAAAAAAEBEg/9oACAEDAQE/AYY//8QAFxEAAwEAAAAAAAAAAAAAAAAAABEgIf/aAAgBAgEBPwFGT//EAB0QAAIBBAMAAAAAAAAAAAAAAAAyAQIgITMxgZH/2gAIAQEABj8CxXM9DSbavBDXIkmTi1xxz//EACEQAAICAAUFAAAAAAAAAAAAAAERACEQMUGRoWFxgdHx/9oACAEBAAE/IWHn4Ib4Rg4qc3Ef4e4pYNpbINzooIQdOXq94iswvbPsIsixrWIGfYT/2gAMAwEAAgADAAAAEAztw3Pf/8QAGREAAwEBAQAAAAAAAAAAAAAAAAERIRBR/9oACAEDAQE/EKbxp+FVaVn/xAAcEQABAwUAAAAAAAAAAAAAAAABEBGhACFBUdH/2gAIAQIBAT8QI4E02sjitZP/xAAhEAEAAgEDBAMAAAAAAAAAAAABABEhMUFRYYGRocHw8f/aAAgBAQABPxCgAFWhjyQsQVgkm0kmK2epeheOn6nYtcQe3KcZe5hOtRbibgDyFMrVGg0JvHPKmFMV3hbh4bQMAD1KibuuA+IsE1GgUwIAftxP/9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"設定後\"\n        title=\"設定後\"\n        src=\"/static/ce47549d903a404be0e80537e8f5eb06/828fb/after.jpg\"\n        srcset=\"/static/ce47549d903a404be0e80537e8f5eb06/ff44c/after.jpg 158w,\n/static/ce47549d903a404be0e80537e8f5eb06/a6688/after.jpg 315w,\n/static/ce47549d903a404be0e80537e8f5eb06/828fb/after.jpg 630w,\n/static/ce47549d903a404be0e80537e8f5eb06/acb04/after.jpg 750w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>  </p>\n<h3>所感</h3>\n<p>これで自宅Wi-Fiに接続していれば、スマートフォンのアプリ内ブラウザでも広告除去ができるようになった。<br>\nしかし、外出先で閲覧した際には広告除去ができない。<br>\ntailescaleなどを利用して外出先から自宅ネットワークに接続し、広告除去できるようにしたい。  </p>","frontmatter":{"title":"Pi-holeで広告ブロック","date":"April 24, 2021","description":null}},"previous":{"fields":{"slug":"/大学生になった/"},"frontmatter":{"title":"大学生になった"}},"next":null},"pageContext":{"id":"642e773d-6ab3-5e40-86b5-b1a06b009589","previousPostId":"6635d5b8-6835-5227-ac02-83196435e3e9","nextPostId":null}},"staticQueryHashes":["2841359383","3257411868"]}