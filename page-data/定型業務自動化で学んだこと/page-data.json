{"componentChunkName":"component---src-templates-blog-post-js","path":"/定型業務自動化で学んだこと/","result":{"data":{"site":{"siteMetadata":{"title":"eginoy Blog"}},"markdownRemark":{"id":"4bc118e5-f6a5-500a-950d-855825012622","excerpt":"要約 リポジトリ 自動化した作業の流れ Google Sheets APIを利用してデータ取得 取得したデータを元にメッセージを生成 生成したメッセージをIncomming Webhook宛に送信 上記の作業を平日1日1回定期的に実行 利用した技術 Google Sheets API Node.js Docker…","html":"<h2>要約</h2>\n<p><a href=\"https://github.com/eginoy/health-care-reminder\">リポジトリ</a></p>\n<p>自動化した作業の流れ</p>\n<ul>\n<li>Google Sheets APIを利用してデータ取得</li>\n<li>取得したデータを元にメッセージを生成</li>\n<li>生成したメッセージをIncomming Webhook宛に送信</li>\n<li>上記の作業を平日1日1回定期的に実行</li>\n</ul>\n<p>利用した技術</p>\n<ul>\n<li>Google Sheets API</li>\n<li>Node.js</li>\n<li>Docker</li>\n<li>Docker-Compose</li>\n<li>GitHub Actions</li>\n</ul>\n<p>新たに学べたこと</p>\n<ul>\n<li>Google Sheets APIを利用したデータの取得方法</li>\n<li>GitHub Actionsの利用方法</li>\n<li>GitHub ActionsでのDocker-Compose実行方法</li>\n<li>GitHub Actionsでのシークレットキーの扱い方</li>\n</ul>\n<h2>きっかけ</h2>\n<p>所属する会社ではコロナ禍が始まってから1日1回検温を行い<a href=\"https://www.health-monitoring.net/\">健康監視ツール</a>を利用して、Google Sheetsに記録をしている。<br>\n健康監視を行う目的からして毎日漏れなく行うことが大切である。<br>\nそのため、毎日終業時刻が近づくと未記録の人を確認してチャット上で記入催促を行う作業が発生した。  </p>\n<p>最初に未記入者チェックを行った先輩が、その後も毎日チェックを行うようになった。<br>\n明示的に誰が毎日の未記入者チェックを行うのか決めなかったため、この先輩が休暇中の時も未記入者チェックを行うようになってしまった。<br>\nたとえ5分とかからない作業であっても、休暇中に業務を行わなければならない状況を改善したかったため、自動化を行うことにした。<br>\n(休暇中、代わりにチェックを行う人を明示的に決めるなどすれば良いが、そもそも人が手作業で行う必要が無いので。)</p>\n<h2>自動化作業でのポイント</h2>\n<h3>Node.jsでIncomming Webhookにメッセージ送信</h3>\n<p>受け取り側はMicrosoft Teams</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> axios <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'axios'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> postData <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>text<span class=\"token operator\">:</span> remindMessage<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\naxios<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span>webhookURL<span class=\"token punctuation\">,</span>postData<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><a href=\"https://qiita.com/penta515/items/074b5c7694b9bcec1043\">参考</a></p>\n<h3>GitHub Actions のAction作成</h3>\n<p>作業フォルダに<code class=\"language-text\">.github/workflows/action.yml</code>を配置</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> run<span class=\"token punctuation\">-</span>reminder\n\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">workflow_dispatch</span><span class=\"token punctuation\">:</span> <span class=\"token comment\">#これ書いとくと手動実行できるようになる。</span>\n  <span class=\"token key atrule\">schedule</span><span class=\"token punctuation\">:</span>\n   <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">cron</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'00 7 * * 1-5'</span> <span class=\"token comment\"># 平日16時(github actions実行時間がUTCなので9時間マイナスで日本時間になる。)</span>\n\n<span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">build</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/checkout@v2\n    \n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> run<span class=\"token punctuation\">-</span>compose\n      <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n       <span class=\"token key atrule\">HEALTHCAREINPUT_BASEURL</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span>secrets.HEALTHCAREINPUT_BASEURL<span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n       <span class=\"token key atrule\">SPREADSHEET_ID</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span>secrets.SPREADSHEET_ID<span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n       <span class=\"token key atrule\">FORMDATASHEET_ID</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span>secrets.FORMDATASHEET_ID<span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n       <span class=\"token key atrule\">USERMASTERSHEET_ID</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span>secrets.USERMASTERSHEET_ID<span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n       <span class=\"token key atrule\">WEBHOOK_URL</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span>secrets.WEBHOOK_URL<span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>    \n      <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> docker<span class=\"token punctuation\">-</span>compose up <span class=\"token punctuation\">-</span>d <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>build\n    \n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> copy<span class=\"token punctuation\">-</span>google<span class=\"token punctuation\">-</span>spreadsheet<span class=\"token punctuation\">-</span>api<span class=\"token punctuation\">-</span>credentials\n      <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n       <span class=\"token key atrule\">SPREADSHEET_SECRETS</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span>secrets.GOOGLE_SPREADSHEET_API_SECRETS<span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n      <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> echo $SPREADSHEET_SECRETS <span class=\"token punctuation\">|</span> base64 <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>decode <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>ignore<span class=\"token punctuation\">-</span>garbage <span class=\"token punctuation\">></span> ./credentials.json\n    \n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> run<span class=\"token punctuation\">-</span>npm<span class=\"token punctuation\">-</span>install<span class=\"token punctuation\">-</span>on<span class=\"token punctuation\">-</span>container\n      <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> docker<span class=\"token punctuation\">-</span>compose exec <span class=\"token punctuation\">-</span>T reminder npm install\n      \n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> run<span class=\"token punctuation\">-</span>reminder\n      <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> docker<span class=\"token punctuation\">-</span>compose exec <span class=\"token punctuation\">-</span>T reminder node src/index.js\n\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> delete<span class=\"token punctuation\">-</span>credentials\n      <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> rm <span class=\"token punctuation\">-</span>rf ./credentials.json\n\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> stop<span class=\"token punctuation\">-</span>containers\n      <span class=\"token key atrule\">if</span><span class=\"token punctuation\">:</span> always()\n      <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> docker<span class=\"token punctuation\">-</span>compose down</code></pre></div>\n<h4>手動実行を可能にする</h4>\n<p>トリガーに<code class=\"language-text\">workflow_dispatch:</code>を指定することで、GitHub Actionsから手動実行が可能になる。<br>\n<a href=\"https://docs.github.com/ja/actions/managing-workflow-runs/manually-running-a-workflow\">参考</a></p>\n<h4>定期実行</h4>\n<p>トリガーに<code class=\"language-text\">schedule:</code>を指定し<code class=\"language-text\">cron:</code>で記述できる。<br>\n実行時間の基準がUTCなので日本時間で指定する際には<code class=\"language-text\">-9</code>時間する。<br>\n例では月曜から金曜日の16時に実行するように設定している。<br>\nただし、指定した時間ピッタリには実行されないので注意。(一度試したら、指定時間+9分後に実行開始した。)<br>\n<a href=\"https://matsuoshi.hatenablog.com/entry/2020/05/10/000000\">参考</a></p>\n<h4>the input device is not a TTYエラー</h4>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 10.126582278481013%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAIAAADXZGvcAAAACXBIWXMAABGvAAARrwH3/UuEAAAAPUlEQVQI143CwRGAMAgEwHQgMFxMODD6sP8WtQPd2cZxcN2ISzwUqaD2FPCz7dVc/JyVXO+Y1THcoJv9+QCCQwndYMptHAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"docker compose exec error\"\n        title=\"docker compose exec error\"\n        src=\"/static/7c95e8af24aecf1740abca93bdfbd408/f058b/docker-compose_exec_error.png\"\n        srcset=\"/static/7c95e8af24aecf1740abca93bdfbd408/c26ae/docker-compose_exec_error.png 158w,\n/static/7c95e8af24aecf1740abca93bdfbd408/6bdcf/docker-compose_exec_error.png 315w,\n/static/7c95e8af24aecf1740abca93bdfbd408/f058b/docker-compose_exec_error.png 630w,\n/static/7c95e8af24aecf1740abca93bdfbd408/40601/docker-compose_exec_error.png 945w,\n/static/7c95e8af24aecf1740abca93bdfbd408/78612/docker-compose_exec_error.png 1260w,\n/static/7c95e8af24aecf1740abca93bdfbd408/01ccc/docker-compose_exec_error.png 1399w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span>\n<code class=\"language-text\">docker-compose exec -T reminder node src/index.js</code><br>\nのように<code class=\"language-text\">exec</code>コマンドに<code class=\"language-text\">-T</code>オプションをつける。<br>\n<a href=\"https://www.nullpo.io/2020/05/11/git-github-actions-docker-compose/\">参考</a></p>\n<h4>シークレットキーのjsonをAction内で扱う</h4>\n<p>APIキーなどが含まれたjsonはどうやって管理しているのか気になって検索していたらたどり着いた方法。<br>\n今回調べた中で一番感心した。<br>\n<a href=\"https://www.notion.so/bfe5bcffba6f489f9c4a2fa29451917c#971c95a2a1864aa0bde022b2d16f9f5a\">参考</a></p>\n<h5>1. credentials.jsonをbase64文字列で取得</h5>\n<p><code class=\"language-text\">credentials.json</code>をAPIキーなどのシークレットキーを含んだjsonファイルとする。<br>\n<code class=\"language-text\">cat ./credentials.json | base64</code></p>\n<h5>2. <code class=\"language-text\">1.</code> で出力したbase64文字列をGitHub Secretsに登録</h5>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/004f0064cbe87830ccca6f6a84e623ba/0a344/githubactions_secrets_regist.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 43.0379746835443%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABGwAAARsAHIJ/VUAAABaUlEQVQoz1VS23aDMAzr67oCpZALEK7toFt36Xa2//80zTKwdg86SRxZke1s9nmJ1FQ42FrXeR+Q+QYHV+s+yUrYosLPZwPrPbaJRZRa7PYW8cFjn1fKiVKHzWNiQFEmksAgSUV9VPABnqPU4yHmXaHnJCuUa8sew/iGsn3CjoIUoVjoJhXmmWQS6n6S+CjrGc3wrOf2eIZvJpjqiFyq0Eokn+LMVUG64CWDq8OKQsMZpug0ich9i8xx30o7mgX1HHPNreRMgkVz+it5BR2TSIehF4fHFzSni65EEMdr7+e2uJtDW/U3Mbm8F084OD9g73pdFbJna+LDkrPwRVCGYoKU04FuCV4YLXHuDx+k2/8odLr3WEq2qNsWp3FCLv0yZScCAaY+wXZPiHKZfioJpp7LUwTtJ0E+f4Mr2nnK29hgHHtcXkdNIMmXAe8fJa7fAdcvwVVa4h228fz31p/B3ttqQC8/IFBQ4r8IfOUj0tc2lAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"githubactions secrets regist\"\n        title=\"githubactions secrets regist\"\n        src=\"/static/004f0064cbe87830ccca6f6a84e623ba/f058b/githubactions_secrets_regist.png\"\n        srcset=\"/static/004f0064cbe87830ccca6f6a84e623ba/c26ae/githubactions_secrets_regist.png 158w,\n/static/004f0064cbe87830ccca6f6a84e623ba/6bdcf/githubactions_secrets_regist.png 315w,\n/static/004f0064cbe87830ccca6f6a84e623ba/f058b/githubactions_secrets_regist.png 630w,\n/static/004f0064cbe87830ccca6f6a84e623ba/40601/githubactions_secrets_regist.png 945w,\n/static/004f0064cbe87830ccca6f6a84e623ba/78612/githubactions_secrets_regist.png 1260w,\n/static/004f0064cbe87830ccca6f6a84e623ba/0a344/githubactions_secrets_regist.png 1741w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h5>3. <code class=\"language-text\">2.</code> で登録したSecretsを環境変数として読み込みjsonファイルとして書き出す。</h5>\n<p>base64文字列をデコードしてjsonファイルへ書き出す。<br>\naction内では以下の箇所で行っている。</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\">   <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> copy<span class=\"token punctuation\">-</span>google<span class=\"token punctuation\">-</span>spreadsheet<span class=\"token punctuation\">-</span>api<span class=\"token punctuation\">-</span>credentials\n      <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n       <span class=\"token key atrule\">SPREADSHEET_SECRETS</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span>secrets.GOOGLE_SPREADSHEET_API_SECRETS<span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n      <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> echo $SPREADSHEET_SECRETS <span class=\"token punctuation\">|</span> base64 <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>decode <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>ignore<span class=\"token punctuation\">-</span>garbage <span class=\"token punctuation\">></span> ./credentials.json</code></pre></div>\n<h3>所感など</h3>\n<p>GitHub Actionsは聞いたことがある程度で具体的に何ができるのか、何をするものなのかを知らなかった。<br>\n今回のように定期的に軽い処理を実行したい場合など十分無料枠で足りるので、幅広い用途に利用でき便利だと思った。  </p>\n<p class='diamond'>&#9830;</p>\n<p>今回の自動化の処理部分を書くのに当たり、以前O’ReillyのTypeScript本を写経してから、一度もTypeScriptを利用していないことを思い出した。<br>\nせっかくなので今回はJavaScriptではなく、TypeScriptで書こうとしたが環境構築につまずいてしまい、結局JavaScriptで書いてしまった。<br>\nこういった機会が無いと業務で扱わない技術を利用することがないので、リファクタリングも兼ねてTypeScriptに書き直そうと思う。</p>","frontmatter":{"title":"定型業務自動化で学んだこと","date":"July 24, 2021","description":null}},"previous":{"fields":{"slug":"/定期的にファイルを削除する/"},"frontmatter":{"title":"自動で定期的にファイルを削除する"}},"next":null},"pageContext":{"id":"4bc118e5-f6a5-500a-950d-855825012622","previousPostId":"77f903a5-0c53-58da-b658-7a46d640ef32","nextPostId":null}},"staticQueryHashes":["2841359383","3257411868"]}